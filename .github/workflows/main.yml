name: Build and Release Executables

# å®šä¹‰è§¦å‘å·¥ä½œæµç¨‹çš„äº‹ä»¶
on:
  push:
    branches:
      - master # å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘æ„å»º
    tags:
      - 'v*' # å½“æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘æ„å»ºå’Œå‘å¸ƒ
  pull_request:
    branches:
      - main # å½“æœ‰æ‹‰å–è¯·æ±‚åˆ° main åˆ†æ”¯æ—¶è§¦å‘æ„å»º (ä¸å‘å¸ƒ)
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµç¨‹

jobs:
  # ==================================================
  # æ„å»º Jobï¼šåœ¨ä¸åŒå¹³å°ä¸Šæ„å»ºå¯æ‰§è¡Œæ–‡ä»¶å¹¶ä¸Šä¼  Artifact
  # ==================================================

  build-windows:
    name: Build on Windows
    runs-on: windows-latest # åœ¨æœ€æ–°çš„ Windows è¿è¡Œå™¨ä¸Šæ‰§è¡Œ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # æ£€å‡ºä»£ç 

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18 # æŒ‡å®šä½¿ç”¨çš„ Node.js ç‰ˆæœ¬ï¼Œè¯·ä¸ä½ çš„é¡¹ç›®å…¼å®¹

      - name: Install dependencies
        run: npm install # æˆ– yarn install

      # å‡è®¾ä½ åœ¨ package.json ä¸­é…ç½®äº† pkgï¼Œå¹¶ä¸”è®¾ç½®äº† bin å­—æ®µ
      # å¦‚æœæ²¡æœ‰ï¼Œè¯·ä¿®æ”¹ä¸‹é¢çš„å‘½ä»¤ä¸º pkg your_entry_file.js -t node18-win-x64
      - name: Build Windows executable
        run: npm install -g pkg && pkg . -t node18-win-x64 # å¦‚æœ pkg æ˜¯ devDependencyï¼Œå¯çœç•¥å…¨å±€å®‰è£…éƒ¨åˆ†å¹¶ä½¿ç”¨ npm run your-pkg-script

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: your-app-windows # Artifact çš„åç§°
          # è¯·æ ¹æ®ä½ çš„ pkg é…ç½®è°ƒæ•´è·¯å¾„ã€‚å¦‚æœ pkg . ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶åœ¨å½“å‰ç›®å½•ï¼Œåç§°ä¸º package.json çš„ name + -win.exe
          path: |
            ./your-app-win.exe # æ›¿æ¢ä¸ºä½ çš„ Windows å¯æ‰§è¡Œæ–‡ä»¶å®é™…è·¯å¾„å’Œåç§°
            # å¦‚æœæœ‰å…¶ä»–éœ€è¦ä¸€èµ·æ‰“åŒ…ä¸Šä¼ çš„ Windows ç›¸å…³æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ·»åŠ åˆ°è¿™é‡Œ

  build-macos:
    name: Build on macOS
    runs-on: macos-latest # åœ¨æœ€æ–°çš„ macOS è¿è¡Œå™¨ä¸Šæ‰§è¡Œ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      # å‡è®¾ä½ åœ¨ package.json ä¸­é…ç½®äº† pkg
      - name: Build macOS executable
        run: npm install -g pkg && pkg . -t node18-macos-x64 # æˆ–ä½¿ç”¨ npm run your-pkg-script

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: your-app-macos # Artifact çš„åç§°
          # è¯·æ ¹æ®ä½ çš„ pkg é…ç½®è°ƒæ•´è·¯å¾„ã€‚å¦‚æœ pkg . ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶åœ¨å½“å‰ç›®å½•ï¼Œåç§°ä¸º package.json çš„ name + -macos
          path: |
            ./your-app-macos # æ›¿æ¢ä¸ºä½ çš„ macOS å¯æ‰§è¡Œæ–‡ä»¶å®é™…è·¯å¾„å’Œåç§°
            # å¦‚æœæœ‰å…¶ä»–éœ€è¦ä¸€èµ·æ‰“åŒ…ä¸Šä¼ çš„ macOS ç›¸å…³æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ·»åŠ åˆ°è¿™é‡Œ

  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„ Ubuntu è¿è¡Œå™¨ä¸Šæ‰§è¡Œ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      # å‡è®¾ä½ åœ¨ package.json ä¸­é…ç½®äº† pkg
      - name: Build Linux executable
        run: npm install -g pkg && pkg . -t node18-linux-x64 # æˆ–ä½¿ç”¨ npm run your-pkg-script

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: your-app-linux # Artifact çš„åç§°
          # è¯·æ ¹æ®ä½ çš„ pkg é…ç½®è°ƒæ•´è·¯å¾„ã€‚å¦‚æœ pkg . ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶åœ¨å½“å‰ç›®å½•ï¼Œåç§°ä¸º package.json çš„ name + -linux
          path: |
            ./your-app-linux # æ›¿æ¢ä¸ºä½ çš„ Linux å¯æ‰§è¡Œæ–‡ä»¶å®é™…è·¯å¾„å’Œåç§°
            # å¦‚æœæœ‰å…¶ä»–éœ€è¦ä¸€èµ·æ‰“åŒ…ä¸Šä¼ çš„ Linux ç›¸å…³æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ·»åŠ åˆ°è¿™é‡Œ

  # ==================================================
  # å‘å¸ƒ Jobï¼šä¸‹è½½ Artifact å¹¶åˆ›å»º GitHub Release
  # ==================================================

  release:
    name: Create Release
    # ç¡®ä¿ Release Job åœ¨æ‰€æœ‰æ„å»º Job æˆåŠŸåæ‰è¿è¡Œ
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest # Release Job å¯ä»¥åœ¨ä»»æ„æ”¯æŒçš„è¿è¡Œå™¨ä¸Šè¿è¡Œ
    # ä»…å½“è§¦å‘äº‹ä»¶æ˜¯æ¨é€æ ‡ç­¾æ—¶è¿è¡Œæ­¤ Job
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # å¦‚æœä½ éœ€è¦åœ¨ Release æè¿°ä¸­åŒ…å«æäº¤ä¿¡æ¯ç­‰ï¼Œéœ€è¦æ£€å‡ºä»£ç 

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts # å°†ä¸‹è½½çš„ Artifact å­˜æ”¾åˆ°ä¸€ä¸ªåä¸º artifacts çš„æ–‡ä»¶å¤¹ä¸­

      - name: List downloaded artifacts (for debugging)
        run: ls -R ./artifacts # åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶ï¼Œæ–¹ä¾¿è°ƒè¯•æŸ¥çœ‹è·¯å¾„

      - name: Create Release
        id: create_release
        # ä½¿ç”¨ä¸€ä¸ªæµè¡Œçš„åˆ›å»º Release çš„ Action
        uses: softprops/action-gh-release@v2
        with:
          # Release çš„åç§°ï¼Œé»˜è®¤ä¸ºæ ‡ç­¾å (ä¾‹å¦‚ v1.0.0)
          # name: ${{ github.ref_name }}
          # Release çš„æè¿°ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ markdown
          body: |
            ğŸ‰ Automated Release ${{ github.ref_name }} ğŸ‰

            This release contains the executable builds for Windows, macOS, and Linux.

            **Downloads:**
            - [Windows]
            - [macOS]
            - [Linux]

            See full changes in ${{ github.ref_name }}.

          # æŒ‡å®šè¦ä½œä¸ºé™„ä»¶ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
          files: |
            ./artifacts/your-app-windows/* # æ›¿æ¢ä¸ºä½ çš„ Windows æ„å»ºäº§ç‰©åœ¨ artifacts ç›®å½•ä¸‹çš„å®é™…è·¯å¾„å’Œåç§°
            ./artifacts/your-app-macos/* # æ›¿æ¢ä¸ºä½ çš„ macOS æ„å»ºäº§ç‰©åœ¨ artifacts ç›®å½•ä¸‹çš„å®é™…è·¯å¾„å’Œåç§°
            ./artifacts/your-app-linux/* # æ›¿æ¢ä¸ºä½ çš„ Linux æ„å»ºäº§ç‰©åœ¨ artifacts ç›®å½•ä¸‹çš„å®é™…è·¯å¾„å’Œåç§°
            # å¦‚æœæœ‰å…¶ä»–é€šç”¨æ–‡ä»¶éœ€è¦æ·»åŠ åˆ°æ‰€æœ‰ Releaseï¼Œä¹Ÿå¯ä»¥æ·»åŠ åˆ°è¿™é‡Œ

        env:
          # GitHub æä¾›çš„å†…ç½® Tokenï¼Œç”¨äºæˆæƒåˆ›å»º Release
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
